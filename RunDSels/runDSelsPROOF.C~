// macro to process analysis TTree with TSelector
#include <iostream> 


#include "TFile.h"
#include "TTree.h"
#include "TString.h"
#include "TSystem.h"
#include "TProof.h"

#include "/work/halld/home/ilbelov/gluex_root_analysis/Linux_Alma9-x86_64-gcc11.5.0/include/DSelector/DPROOFLiteManager.h"



void runDSelsPROOF(TString runNumber = "4") 
{

  const char *sampleDir = "/volatile/halld/home/ilbelov/TestDataSpring2018/merged/";
  const char *treeName = "pippippimpim__B4_Tree";
  const char *myDSelector = "/work/halld/home/ilbelov/RunDSels/DSelData_2pip2pim.C";
  
    
  // Load DSelector library
  gROOT->ProcessLine(".x $ROOT_ANALYSIS_HOME/scripts/Load_DSelector.C");
  int Proof_Nthreads = 4;


  //sampleDir += Form("0%s/", runNumber.Data());
  //if(myPath.Contains("thrown")) treeName = "Thrown_Tree"; 

  
  cout << "running selector on files in: " << sampleDir <<endl;
 

  TChain *chain = new TChain(treeName);
  TSystemDirectory dir(sampleDir, sampleDir);
  TList *files = dir.GetListOfFiles();
  int ifile = 0;
  if(files) {
	  TSystemFile *file;
	  TString fileName;
	  TIter next(files);
	  cout << "Found files are:" << endl;  

	  // loop over files
	  while ((file=(TSystemFile*)next())) {
		  fileName = file->GetName();
		  if(fileName.Contains(runNumber)) {
			  cout << fileName << endl;
			  
			  // check if file corrupted
			  TFile f(sampleDir+fileName);
			  if(f.TestBit(TFile::kRecovered)) {
				  cout<<"file corrupted -> skipping"<<endl;
				  continue;
			  }
			  if(f.IsZombie()) {
				  cout<<"file is a Zombie -> skipping"<<endl;
				  continue;
			  }
			  
			  // add file to chain
			  chain->Add(sampleDir+fileName);
			  ifile++; if (ifile==4) break;
		  }
	  }
	  
	 cout<<"total entries in TChain = "<<chain->GetEntries()<<" from "<<ifile<<" files"<<endl;
  	 DPROOFLiteManager::Process_Chain(chain, Form("%s+", myDSelector), Proof_Nthreads, "outfilehist.root", "outfiletree.root");


	 //	  chain->SetProof();
	  //proof->Process(Form("%s+", myDSelector),100000);

	 // 	 	 chain->Process("DSelData_2pip2pim.C+");
  }

  return;
}
